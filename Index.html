<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odoo Permissions Manager</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>        /* Estilos personalizados */
        .permission-card {
            transition: all 0.3s;
            border-left: 4px solid #0d6efd;
        }
        .permission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .group-item {
            cursor: pointer;
            margin: 4px;
            transition: all 0.2s;
        }
        .group-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .inherited-permission {
            background-color: #e8f4ff;
            border-left-color: #6ea8fe;
        }
        #permissionsTree {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Estilos para el árbol de permisos */
        .module-item {
            border-left: 3px solid #198754;
            padding: 8px 12px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .module-item:hover {
            background-color: #e9f0e9;
        }
        .module-item.active {
            background-color: #d1e7dd;
            border-left-width: 5px;
        }
        .model-list {
            padding-left: 20px;
        }
        .model-item {
            padding: 6px 10px;
            margin: 5px 0;
            border-left: 2px solid #6c757d;
            background-color: #ffffff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .model-item:hover {
            background-color: #f1f3f5;
        }
        .model-item.active {
            background-color: #e9ecef;
            border-left: 2px solid #0d6efd;
        }
        .permission-badge {
            font-size: 0.7rem;
            padding: 2px 5px;
            margin-left: 5px;
        }
        
        /* Estilos para tooltips */
        .tooltip-content {
            max-width: 300px;
            font-size: 0.875rem;
        }
        .tooltip-header {
            font-weight: bold;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .tooltip-body {
            padding: 0.25rem 0;
        }
        .permission-counts {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .permission-details {
            margin-top: 0.5rem;
        }
        .perm-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        .perm-row i {
            margin-right: 0.5rem;
        }
        .perm-row.inactive {
            opacity: 0.7;
        }
        .permission-tooltip {
            cursor: help;
        }
        
        /* Estilos para el panel de permisos específicos */
        .form-check-input.permission-toggle {
            width: 2.5em;
        }
        .form-check-input.permission-toggle:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        
        /* Estilos para las pestañas de usuarios y grupos */
        .nav-tabs .nav-link {
            color: #6c757d;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <header class="d-flex justify-content-between align-items-center mb-4">            <h1 class="h3">
                <i class="fas fa-user-shield me-2"></i>Gestor de Permisos Odoo
            </h1>
            <div class="d-flex">
                <button id="compareBtn" class="btn btn-outline-info me-2" title="Comparar permisos entre usuarios">
                    <i class="fas fa-balance-scale me-1"></i> Comparar
                </button>
                <button id="refreshBtn" class="btn btn-outline-primary me-2">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
                <div class="input-group" style="width: 300px;">
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar usuario/grupo...">
                    <button class="btn btn-primary" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </header>        <!-- Nueva barra de información -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <small id="filterInfoText">Seleccione un usuario o grupo para gestionar sus permisos.</small>
                </div>
            </div>
        </div>        <!-- Contenido principal - Diseño de 3 paneles -->
        <div class="row">
            <!-- PANEL 1: Selección de usuario o grupo -->
            <div class="col-md-3">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-users me-2"></i>Usuarios y Grupos
                        </div>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="showOnlySystemUsers" checked>
                            <label class="form-check-label text-white" for="showOnlySystemUsers">
                                <small>Solo sistema</small>
                            </label>
                        </div>
                    </div>
                    <div class="p-2 bg-light border-bottom">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="userSearchInput" class="form-control" placeholder="Buscar...">
                            <button class="btn btn-outline-secondary" type="button" id="userSearchClear">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <ul class="nav nav-tabs" id="userTypeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-tab-pane" 
                                        type="button" role="tab" aria-selected="true">Usuarios</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups-tab-pane" 
                                        type="button" role="tab" aria-selected="false">Grupos</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="userTypeTabsContent">
                            <div class="tab-pane fade show active" id="users-tab-pane" role="tabpanel" tabindex="0">
                                <div class="list-group list-group-flush" id="usersList">
                                    <!-- Se poblará dinámicamente con usuarios -->
                                </div>
                            </div>
                            <div class="tab-pane fade" id="groups-tab-pane" role="tabpanel" tabindex="0">
                                <div class="list-group list-group-flush" id="groupsList">
                                    <!-- Se poblará dinámicamente con grupos -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PANEL 2: Árbol de permisos por módulo -->
            <div class="col-md-5">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-project-diagram me-2"></i>Permisos por Módulo
                        </div>
                        <div>
                            <select id="moduleFilter" class="form-select form-select-sm">
                                <option value="">Todos los módulos</option>
                                <!-- Se poblará dinámicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="fas fa-filter"></i></span>
                                <input type="text" id="permissionSearchInput" class="form-control" placeholder="Filtrar permisos...">
                            </div>
                        </div>
                        <div id="permissionsTree" class="overflow-auto" style="max-height: 500px;">
                            <!-- Árbol de permisos organizado por módulo -->
                            <ul class="list-unstyled">
                                <!-- Se generará dinámicamente -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PANEL 3: Gestión de permisos específicos -->
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-user-cog me-2"></i>Detalles de Permisos
                    </div>
                    <div class="card-body">                        <div class="row mb-3">
                            <div class="col">
                                <h5 id="selectedUserName">Seleccione un usuario o grupo</h5>
                                <div id="userInfo">
                                    <!-- Información detallada del usuario -->
                                </div>
                                <div id="userBadges" class="d-flex flex-wrap gap-2">
                                    <!-- Badges de grupos asignados si es un usuario -->
                                </div>
                            </div>
                        </div>
                        
                        <div id="permissionDetailsContainer">
                            <div class="alert alert-secondary">
                                <i class="fas fa-info-circle me-2"></i>
                                Seleccione un elemento del árbol de permisos para gestionar sus permisos específicos.
                            </div>
                            
                            <div id="permissionChecklist" class="d-none">
                                <h6 id="selectedModelName" class="border-bottom pb-2 mb-3">Modelo: <span></span></h6>
                                
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input permission-toggle" type="checkbox" id="perm_read" 
                                           data-perm-type="read">
                                    <label class="form-check-label" for="perm_read">
                                        <i class="fas fa-eye me-2"></i>Permiso de Lectura
                                    </label>
                                </div>
                                
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input permission-toggle" type="checkbox" id="perm_write" 
                                           data-perm-type="write">
                                    <label class="form-check-label" for="perm_write">
                                        <i class="fas fa-edit me-2"></i>Permiso de Escritura
                                    </label>
                                </div>
                                
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input permission-toggle" type="checkbox" id="perm_create" 
                                           data-perm-type="create">
                                    <label class="form-check-label" for="perm_create">
                                        <i class="fas fa-plus-circle me-2"></i>Permiso de Creación
                                    </label>
                                </div>
                                
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input permission-toggle" type="checkbox" id="perm_unlink" 
                                           data-perm-type="unlink">
                                    <label class="form-check-label" for="perm_unlink">
                                        <i class="fas fa-trash-alt me-2"></i>Permiso de Eliminación
                                    </label>
                                </div>
                                
                                <div class="d-grid gap-2 mt-4">
                                    <button id="savePermissionsBtn" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Guardar Cambios
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>                </div>
            </div>
        </div>
        
        <!-- Panel de comparación de permisos entre usuarios -->
        <div class="row mt-4" id="comparisonPanel" style="display: none;">
            <div class="col-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-balance-scale me-2"></i>Comparación de Permisos entre Usuarios
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-light" id="closeComparisonBtn">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label for="user1Select" class="form-label">Primer Usuario:</label>
                                    <select id="user1Select" class="form-select">
                                        <option value="">Seleccione un usuario...</option>
                                        <!-- Se poblará dinámicamente -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2 text-center d-flex align-items-center justify-content-center">
                                <div class="fw-bold">VS</div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label for="user2Select" class="form-label">Segundo Usuario:</label>
                                    <select id="user2Select" class="form-select">
                                        <option value="">Seleccione un usuario...</option>
                                        <!-- Se poblará dinámicamente -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-12 text-center">
                                <button id="runComparisonBtn" class="btn btn-primary">
                                    <i class="fas fa-play-circle me-2"></i>Realizar Comparación
                                </button>
                            </div>
                        </div>
                        
                        <!-- Resultados de la comparación -->
                        <div id="comparisonResultsContainer" class="mt-4" style="display: none;">
                            <ul class="nav nav-tabs" id="comparisonTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="differences-tab" data-bs-toggle="tab" 
                                            data-bs-target="#differences-tab-pane" type="button" role="tab">
                                        <i class="fas fa-not-equal me-1"></i>Diferencias
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="common-tab" data-bs-toggle="tab" 
                                            data-bs-target="#common-tab-pane" type="button" role="tab">
                                        <i class="fas fa-equals me-1"></i>Permisos Comunes
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="all-tab" data-bs-toggle="tab" 
                                            data-bs-target="#all-tab-pane" type="button" role="tab">
                                        <i class="fas fa-list me-1"></i>Todos los Permisos
                                    </button>
                                </li>
                            </ul>
                            <div class="tab-content p-3 border border-top-0 rounded-bottom" id="comparisonTabsContent">
                                <div class="tab-pane fade show active" id="differences-tab-pane" role="tabpanel" tabindex="0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Módulo</th>
                                                    <th>Modelo</th>
                                                    <th>Permiso</th>
                                                    <th id="user1Header">Usuario 1</th>
                                                    <th id="user2Header">Usuario 2</th>
                                                </tr>
                                            </thead>
                                            <tbody id="differencesList">
                                                <!-- Se poblará dinámicamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="noDifferencesMsg" class="alert alert-success" style="display: none;">
                                        <i class="fas fa-check-circle me-2"></i>No se encontraron diferencias de permisos entre los usuarios seleccionados.
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="common-tab-pane" role="tabpanel" tabindex="0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Módulo</th>
                                                    <th>Modelo</th>
                                                    <th>Permisos Comunes</th>
                                                </tr>
                                            </thead>
                                            <tbody id="commonPermsList">
                                                <!-- Se poblará dinámicamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="noCommonPermsMsg" class="alert alert-warning" style="display: none;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>No se encontraron permisos comunes entre los usuarios seleccionados.
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="all-tab-pane" role="tabpanel" tabindex="0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Módulo</th>
                                                    <th>Modelo</th>
                                                    <th>Tipo</th>
                                                    <th id="allUser1Header">Usuario 1</th>
                                                    <th id="allUser2Header">Usuario 2</th>
                                                </tr>
                                            </thead>
                                            <tbody id="allPermsList">
                                                <!-- Se poblará dinámicamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles -->
    <div class="modal fade" id="permissionDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de Permiso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Modelos afectados:</h6>
                            <ul id="affectedModels" class="list-group">
                                <!-- Se poblará dinámicamente -->
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Permisos CRUD:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Modelo</th>
                                            <th>Lectura</th>
                                            <th>Escritura</th>
                                            <th>Crear</th>
                                            <th>Eliminar</th>
                                        </tr>
                                    </thead>
                                    <tbody id="crudPermissions">
                                        <!-- Se poblará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>    <!-- Bootstrap JS y dependencias -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Script de comparación -->
    <script>
// Variables globales
let allUsers = [];
let allGroups = [];
let odooSessionId = null;
let selectedUserId = null;

/**
 * Funciones para la persistencia de selecciones del usuario mediante localStorage
 */

// Guarda la selección actual del usuario
function saveUserSelection() {
    if (!selectedUserId) return;
    
    const selectionData = {
        userId: selectedUserId,
        isGroup: document.querySelector('#usersList a.active') ? false : true,
        timestamp: new Date().getTime()
    };
    
    localStorage.setItem('odooPermManager_lastSelection', JSON.stringify(selectionData));
}

// Restaura la última selección del usuario
function restoreUserSelection() {
    const savedData = localStorage.getItem('odooPermManager_lastSelection');
    if (!savedData) return false;
    
    try {
        const selection = JSON.parse(savedData);
        
        // Verificar si los datos no están obsoletos (más de 1 día)
        const oneDayMs = 24 * 60 * 60 * 1000;
        if (new Date().getTime() - selection.timestamp > oneDayMs) {
            localStorage.removeItem('odooPermManager_lastSelection');
            return false;
        }
        
        // Seleccionar el elemento correspondiente
        if (selection.isGroup) {
            const groupItem = document.querySelector(`#groupsList a[data-group-id="${selection.userId}"]`);
            if (groupItem) {
                // Activar la pestaña de grupos
                document.getElementById('groups-tab').click();
                // Hacer clic en el grupo
                groupItem.click();
                return true;
            }
        } else {
            const userItem = document.querySelector(`#usersList a[data-user-id="${selection.userId}"]`);
            if (userItem) {
                // Activar la pestaña de usuarios
                document.getElementById('users-tab').click();
                // Hacer clic en el usuario
                userItem.click();
                return true;
            }
        }
    } catch (e) {
        console.error('Error al restaurar selección:', e);
        localStorage.removeItem('odooPermManager_lastSelection');
    }
    
    return false;
}

// Guarda configuraciones de la interfaz (ej. filtros, vistas)
function saveUISettings() {
    const settings = {
        showOnlySystemUsers: document.getElementById('showOnlySystemUsers').checked,
        lastActiveTab: document.querySelector('#userTypeTabs .nav-link.active').id,
        lastComparisonTab: document.querySelector('#comparisonTabs .nav-link.active')?.id || 'differences-tab',
        filterText: document.getElementById('searchInput').value,
        timestamp: new Date().getTime()
    };
    
    localStorage.setItem('odooPermManager_uiSettings', JSON.stringify(settings));
}

// Restaura las configuraciones de la interfaz
function restoreUISettings() {
    const savedData = localStorage.getItem('odooPermManager_uiSettings');
    if (!savedData) return false;
    
    try {
        const settings = JSON.parse(savedData);
        
        // Verificar si los datos no están obsoletos (más de 7 días)
        const sevenDaysMs =  7 * 24 * 60 * 60 * 1000;
        if (new Date().getTime() - settings.timestamp > sevenDaysMs) {
            localStorage.removeItem('odooPermManager_uiSettings');
            return false;
        }
        
        // Restaurar configuraciones
        if (settings.showOnlySystemUsers !== undefined) {
            document.getElementById('showOnlySystemUsers').checked = settings.showOnlySystemUsers;
        }
        
        if (settings.lastActiveTab) {
            document.getElementById(settings.lastActiveTab)?.click();
        }
        
        if (settings.filterText) {
            document.getElementById('searchInput').value = settings.filterText;
            filterUserAndGroupLists(); // Aplicar el filtro
        }
        
        return true;
    } catch (e) {
        console.error('Error al restaurar configuraciones:', e);
        localStorage.removeItem('odooPermManager_uiSettings');
    }
    
    return false;
}

// Configurar eventos para guardar selecciones y configuraciones
document.addEventListener('DOMContentLoaded', function() {
    // Configurar la persistencia
    const existingDOMContentLoaded = document.readyState === 'complete';
    
    // Si la función ya se ejecutó anteriormente (por el DOMContentLoaded original)
    if (existingDOMContentLoaded) {
        setupLocalStoragePersistence();
    } else {
        // Añadir al final de la cola de eventos
        setTimeout(setupLocalStoragePersistence, 0);
    }
});

// Configura los eventos para la persistencia de datos
function setupLocalStoragePersistence() {
    // Guardar selección cuando se hace clic en un usuario o grupo
    document.querySelectorAll('#usersList, #groupsList').forEach(list => {
        list.addEventListener('click', function(e) {
            if (e.target.closest('a')) {
                // Esperar a que se complete la actualización de la UI
                setTimeout(saveUserSelection, 100);
            }
        });
    });
    
    // Guardar configuraciones cuando cambian
    document.getElementById('showOnlySystemUsers').addEventListener('change', saveUISettings);
    document.getElementById('searchInput').addEventListener('input', saveUISettings);
    
    // Guardar la pestaña activa cuando cambia
    document.querySelectorAll('#userTypeTabs .nav-link, #comparisonTabs .nav-link').forEach(tab => {
        tab.addEventListener('shown.bs.tab', saveUISettings);
    });
    
    // Restaurar configuraciones al cargar
    document.getElementById('refreshBtn').addEventListener('click', function() {
        // Guardar configuraciones actuales antes de recargar
        saveUISettings();
        saveUserSelection();
    });
    
    // Modificar la función loadInitialData para restaurar después de cargar
    const originalLoadInitialData = loadInitialData;
    loadInitialData = function() {
        originalLoadInitialData.call(this);
        
        // Después de cargar los datos, restaurar configuraciones y selección
        setTimeout(() => {
            restoreUISettings();
            restoreUserSelection();
        }, 500);
    };
}

/**
 * Optimizaciones de carga y rendimiento
 */

// Función para cargar datos de forma optimizada
function loadOptimizedData() {
    showLoading('Cargando datos...');
    
    // Flag para controlar la carga asíncrona
    let loadedUsers = false;
    let loadedGroups = false;
    
    // Variable para almacenar módulos
    let modulesData = null;
    
    // Función para finalizar cuando todo está cargado
    function finishLoading() {
        if (loadedUsers && loadedGroups && modulesData) {
            // Mostrar los datos iniciales
            populateUsersList();
            populateGroupsList();
            populateUserSelects();
            
            // Mostrar el árbol de permisos sólo si hay módulos
            if (modulesData.modules && modulesData.modules.length > 0) {
                displayPermissionsTree(modulesData.modules, null);
                
                // Poblar selector de filtro de módulos
                populateModuleFilter(modulesData.modules);
            }
            
            // Restaurar UI
            setTimeout(() => {
                restoreUISettings();
                restoreUserSelection();
            }, 300);
            
            hideLoading();
        }
    }
    
    // Cargar usuarios
    google.script.run
        .withSuccessHandler(userResult => {
            if (userResult.success) {
                allUsers = userResult.users;
                console.log(`Cargados ${allUsers.length} usuarios`);
                loadedUsers = true;
                finishLoading();
            } else {
                hideLoading();
                showError('Error al cargar usuarios: ' + (userResult.error || 'Desconocido'));
            }
        })
        .withFailureHandler(error => {
            hideLoading();
            showError('Error al cargar usuarios: ' + error);
        })
        .getUsers(odooSessionId);
    
    // Cargar grupos (en paralelo)
    google.script.run
        .withSuccessHandler(groupResult => {
            if (groupResult.success) {
                allGroups = groupResult.groups;
                console.log(`Cargados ${allGroups.length} grupos`);
                loadedGroups = true;
                finishLoading();
            } else {
                hideLoading();
                showError('Error al cargar grupos: ' + (groupResult.error || 'Desconocido'));
            }
        })
        .withFailureHandler(error => {
            hideLoading();
            showError('Error al cargar grupos: ' + error);
        })
        .getGroups(odooSessionId);
    
    // Cargar módulos (en paralelo)
    google.script.run
        .withSuccessHandler(result => {
            if (result.success) {
                modulesData = result;
                console.log(`Cargados ${result.modules.length} módulos`);
                finishLoading();
            } else {
                hideLoading();
                showError('Error al cargar módulos: ' + (result.error || 'Desconocido'));
            }
        })
        .withFailureHandler(error => {
            hideLoading();
            showError('Error al cargar módulos: ' + error);
        })
        .getModules(odooSessionId);
}

// Poblar el selector de filtro de módulos
function populateModuleFilter(modules) {
    const moduleFilter = document.getElementById('moduleFilter');
    moduleFilter.innerHTML = '<option value="">Todos los módulos</option>';
    
    // Ordenar módulos alfabéticamente
    const sortedModules = [...modules]
        .filter(module => module.models && module.models.length > 0)
        .sort((a, b) => a.shortdesc.localeCompare(b.shortdesc));
    
    // Añadir opciones para cada módulo
    sortedModules.forEach(module => {
        const option = document.createElement('option');
        option.value = module.id;
        option.textContent = `${module.shortdesc} (${module.models.length})`;
        moduleFilter.appendChild(option);
    });
    
    // Configurar evento para filtrar
    moduleFilter.addEventListener('change', filterPermissionsTree);
}

// Filtrar el árbol de permisos según el módulo seleccionado
function filterPermissionsTree() {
    const moduleId = document.getElementById('moduleFilter').value;
    const searchText = document.getElementById('permissionSearchInput').value.toLowerCase();
    
    // Filtrar módulos
    document.querySelectorAll('.module-item').forEach(moduleItem => {
        const moduleIdAttr = moduleItem.getAttribute('data-module-id');
        const moduleName = moduleItem.querySelector('.module-name').textContent.toLowerCase();
        
        const matchesModule = !moduleId || moduleIdAttr === moduleId;
        const matchesSearch = !searchText || moduleName.includes(searchText);
        
        if (matchesModule && matchesSearch) {
            moduleItem.style.display = '';
        } else if (!matchesModule) {
            moduleItem.style.display = 'none';
        } else {
            // Si el módulo no coincide con la búsqueda, pero podría tener modelos que sí
            moduleItem.style.display = '';
            
            // Buscar en modelos dentro del módulo
            let hasVisibleModels = false;
            moduleItem.querySelectorAll('.model-item').forEach(modelItem => {
                const modelName = modelItem.querySelector('.model-name').textContent.toLowerCase();
                const modelTech = modelItem.getAttribute('data-model-name').toLowerCase();
                
                if (modelName.includes(searchText) || modelTech.includes(searchText)) {
                    modelItem.style.display = '';
                    hasVisibleModels = true;
                } else {
                    modelItem.style.display = 'none';
                }
            });
            
            // Si ningún modelo coincide, ocultar el módulo
            if (!hasVisibleModels) {
                moduleItem.style.display = 'none';
            } else {
                // Expandir el módulo para mostrar los resultados
                const modelList = moduleItem.querySelector('.model-list');
                if (!modelList.classList.contains('show')) {
                    new bootstrap.Collapse(modelList).show();
                    const chevron = moduleItem.querySelector('.fa-chevron-down');
                    if (chevron) {
                        chevron.classList.replace('fa-chevron-down', 'fa-chevron-up');
                    }
                }
            }
        }
    });
    
    // Actualizar información sobre filtros activos
    updateFilterInfo();
}

// Actualizar la información sobre filtros activos
function updateFilterInfo() {
    const infoText = document.getElementById('filterInfoText');
    const moduleFilter = document.getElementById('moduleFilter');
    const searchText = document.getElementById('permissionSearchInput').value;
    
    let info = 'Seleccione un usuario o grupo para gestionar sus permisos.';
    
    if (moduleFilter.value || searchText) {
        info = 'Filtros activos: ';
        
        if (moduleFilter.value) {
            const selectedOption = moduleFilter.options[moduleFilter.selectedIndex];
            info += `Módulo: "${selectedOption.textContent}"`;
        }
        
        if (searchText) {
            if (moduleFilter.value) info += ' | ';
            info += `Búsqueda: "${searchText}"`;
        }
    }
    
    infoText.textContent = info;
}

// Configurar filtros adicionales y eventos de búsqueda
function setupAdvancedFilters() {
    // Filtro de búsqueda de permisos
    const permSearchInput = document.getElementById('permissionSearchInput');
    permSearchInput.addEventListener('input', function() {
        filterPermissionsTree();
    });
    
    // Filtros de usuarios y grupos
    const userSearchInput = document.getElementById('userSearchInput');
    userSearchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        // Filtrar según la pestaña activa
        if (document.getElementById('users-tab').classList.contains('active')) {
            document.querySelectorAll('#usersList a').forEach(item => {
                const userName = item.querySelector('.fw-medium').textContent.toLowerCase();
                const userDetails = item.querySelector('.text-muted').textContent.toLowerCase();
                
                if (userName.includes(searchTerm) || userDetails.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        } else {
            document.querySelectorAll('#groupsList a').forEach(item => {
                const groupName = item.textContent.toLowerCase();
                
                if (groupName.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
    });
    
    // Limpiar búsqueda de usuarios/grupos
    document.getElementById('userSearchClear').addEventListener('click', function() {
        userSearchInput.value = '';
        userSearchInput.dispatchEvent(new Event('input'));
    });
    
    // Mostrar solo usuarios del sistema
    document.getElementById('showOnlySystemUsers').addEventListener('change', function() {
        populateUsersList(); // Repoblar la lista con el nuevo filtro
    });
}

/**
 * Mejoras de accesibilidad
 */
function setupAccessibilityEnhancements() {
    // Añadir atributos ARIA a elementos interactivos
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.setAttribute('aria-role', 'tab');
    });
    
    // Añadir etiquetas a campos de búsqueda
    document.getElementById('searchInput').setAttribute('aria-label', 'Buscar usuario o grupo');
    document.getElementById('userSearchInput').setAttribute('aria-label', 'Filtrar usuarios o grupos');
    document.getElementById('permissionSearchInput').setAttribute('aria-label', 'Filtrar permisos');
    
    // Mejorar interactividad con el teclado
    document.querySelectorAll('.model-item, .module-item, #usersList a, #groupsList a').forEach(item => {
        item.setAttribute('tabindex', '0');
        
        // Permitir activación con teclado
        item.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });
    
    // Añadir tooltips a elementos con iconos
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
        new bootstrap.Tooltip(el);
    });
    
    // Añadir tooltips a elementos que solo tienen iconos
    document.querySelectorAll('button, .btn').forEach(btn => {
        const hasText = Array.from(btn.childNodes).some(node => 
            node.nodeType === Node.TEXT_NODE && node.textContent.trim().length > 0
        );
        
        const hasTitle = btn.hasAttribute('title');
        
        if (!hasText && !hasTitle && btn.querySelector('i.fas, i.far, i.fab')) {
            // Intentar generar título a partir del aria-label o texto de elementos hijos
            let title = btn.getAttribute('aria-label');
            
            if (!title) {
                const span = btn.querySelector('span');
                if (span) {
                    title = span.textContent.trim();
                }
            }
            
            if (title) {
                btn.setAttribute('title', title);
                new bootstrap.Tooltip(btn);
            }
        }
    });
    
    // Añadir feedback auditivo para operaciones importantes
    document.getElementById('savePermissionsBtn').addEventListener('click', function() {
        // Se anunciará para lectores de pantalla
        const announcement = document.createElement('div');
        announcement.setAttribute('role', 'status');
        announcement.setAttribute('aria-live', 'polite');
        announcement.className = 'sr-only';
        announcement.textContent = 'Guardando permisos...';
        document.body.appendChild(announcement);
        
        // Eliminar después de 3 segundos
        setTimeout(() => {
            if (document.body.contains(announcement)) {
                document.body.removeChild(announcement);
            }
        }, 3000);
    });
    
    // Añadir enfoque mejorado para elementos navegables
    const style = document.createElement('style');
    style.textContent = `
        :focus-visible {
            outline: 3px solid #1a73e8;
            outline-offset: 2px;
        }
        
        /* Mejoras visuales para modo de alto contraste */
        @media (forced-colors: active) {
            .permission-card {
                border: 1px solid CanvasText;
            }
            .badge {
                border: 1px solid CanvasText;
            }
        }
    `;
    document.head.appendChild(style);
    
    // Configurar manejo de errores accesible
    window.addEventListener('error', function(e) {
        // Anunciar errores para lectores de pantalla
        const announcement = document.createElement('div');
        announcement.setAttribute('role', 'alert');
        announcement.setAttribute('aria-live', 'assertive');
        announcement.className = 'sr-only';
        announcement.textContent = 'Error en la aplicación: ' + e.message;
        document.body.appendChild(announcement);
        
        // Eliminar después de 5 segundos
        setTimeout(() => {
            if (document.body.contains(announcement)) {
                document.body.removeChild(announcement);
            }
        }, 5000);
        
        // No detener la propagación del error
        return false;
    });
    
    console.log('Mejoras de accesibilidad configuradas');
}

// Sobrescribir loadInitialData para usar la versión optimizada
document.addEventListener('DOMContentLoaded', function() {
    // Preservar referencia original
    const originalLoadInitialData = loadInitialData;
    
    // Sobrescribir con versión optimizada
    loadInitialData = loadOptimizedData;
    
    // Configurar filtros avanzados
    setupAdvancedFilters();
    
    // Eventos adicionales para mejorar la accesibilidad
    setupAccessibilityEnhancements();
});


/**
 * Actualiza los badges de permisos en el árbol de modelos
 * @param {string} modelName - Nombre técnico del modelo
 * @param {Object} permissions - Objeto con permisos del modelo
 */
function updatePermissionBadgesInTree(modelName, permissions) {
    // Buscar el elemento del modelo en el árbol
    const modelItem = document.querySelector(`.model-item[data-model-name="${modelName}"]`);
    if (!modelItem) return;
    
    // Contenedor de badges
    const badgesContainer = modelItem.querySelector('.permission-badges');
    if (!badgesContainer) return;
    
    // Limpiar badges existentes
    badgesContainer.innerHTML = '';
    
    // Tipos de permisos y sus colores
    const permTypes = [
        { type: 'read', label: 'R', color: 'bg-info' },
        { type: 'write', label: 'W', color: 'bg-primary' },
        { type: 'create', label: 'C', color: 'bg-warning text-dark' },
        { type: 'unlink', label: 'D', color: 'bg-danger' }
    ];
    
    // Crear badges para cada tipo de permiso
    permTypes.forEach(perm => {
        if (permissions[perm.type]) {
            const badge = document.createElement('span');
            badge.className = `badge ${perm.color} permission-badge`;
            badge.textContent = perm.label;
            
            // Añadir clase si es un permiso heredado
            if (permissions[`${perm.type}_inherited`]) {
                badge.classList.add('opacity-75');
                badge.title = 'Heredado de otro grupo';
            }
            
            badgesContainer.appendChild(badge);
        }
    });
}

/**
 * Obtiene y muestra los permisos para un modelo específico
 * @param {string} modelName - Nombre técnico del modelo (ej: "res.users")
 * @param {number} userId - ID del usuario o grupo
 * @param {boolean} isGroup - Indica si el ID es de un grupo
 */
function getModelPermissions(modelName, userId, isGroup = false) {
    showLoading('Obteniendo permisos...');
    
    google.script.run
        .withSuccessHandler(result => {
            if (result.success) {
                const permissions = result.permissions;
                
                // Actualizar la visualización de permisos en el panel de detalles
                updatePermissionChecklist(modelName, permissions, userId, isGroup);
                
                // Actualizar los badges de permisos en el árbol
                updatePermissionBadgesInTree(modelName, permissions);
            } else {
                showError('Error al obtener permisos: ' + (result.error || 'Error desconocido'));
            }
            hideLoading();
        })
        .withFailureHandler(error => {
            showError('Error: ' + error);
            hideLoading();
        })
        .getModelPermissions(odooSessionId, modelName, userId, isGroup);
}

/**
 * Genera un gráfico visual de relaciones entre grupos y permisos
 * @param {Array} userGroups - Lista de grupos del usuario
 */
function generatePermissionVisualizations(userGroups) {
    // Crear contenedor para el resumen visual si no existe
    let summaryContainer = document.getElementById('permissionSummaryChart');
    if (!summaryContainer) {
        summaryContainer = document.createElement('div');
        summaryContainer.id = 'permissionSummaryChart';
        summaryContainer.className = 'permission-summary-chart mt-3 mb-3 p-3 border rounded bg-light';
        
        // Insertar después del contenedor de badges
        const userBadgesContainer = document.getElementById('userBadges');
        userBadgesContainer.parentNode.insertBefore(summaryContainer, userBadgesContainer.nextSibling);
    }
    
    // Limpiar contenido existente
    summaryContainer.innerHTML = '<h6 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Resumen de permisos</h6>';
    
    // Crear gráfico visual básico de distribución de permisos
    const chartContainer = document.createElement('div');
    chartContainer.className = 'd-flex flex-wrap justify-content-center gap-2 mb-3';
    
    // Categorías comunes de permisos
    const permissionCategories = [
        { name: 'Gestión de usuarios', color: '#4285F4', icon: 'fa-users' },
        { name: 'Contabilidad', color: '#34A853', icon: 'fa-file-invoice-dollar' },
        { name: 'Ventas', color: '#FBBC05', icon: 'fa-shopping-cart' },
        { name: 'Inventario', color: '#EA4335', icon: 'fa-boxes' },
        { name: 'Configuración', color: '#673AB7', icon: 'fa-cogs' },
        { name: 'Informes', color: '#FF9800', icon: 'fa-chart-bar' },
        { name: 'Otros', color: '#9E9E9E', icon: 'fa-ellipsis-h' }
    ];
    
    // Calcular tamaño relativo basado en los grupos
    permissionCategories.forEach(category => {
        // Filtrar grupos por categoría (simulado - en producción se haría según nombres/categorías reales)
        const relatedGroups = userGroups.filter(group => 
            group.name.toLowerCase().includes(category.name.toLowerCase()) ||
            (group.category_id && group.category_id[1].toLowerCase().includes(category.name.toLowerCase()))
        );
        
        // Calcular tamaño (mínimo 1, máximo 5)
        const size = Math.min(5, Math.max(1, Math.ceil(relatedGroups.length / 2)));
        
        // Crear elemento visual
        const categoryBox = document.createElement('div');
        categoryBox.className = 'd-flex flex-column align-items-center text-center p-2';
        categoryBox.style.width = '100px';
        
        // Círculo con tamaño relativo
        const circle = document.createElement('div');
        circle.className = 'rounded-circle d-flex align-items-center justify-content-center mb-2';
        circle.style.width = `${30 + (size * 10)}px`;
        circle.style.height = `${30 + (size * 10)}px`;
        circle.style.backgroundColor = category.color;
        circle.style.color = 'white';
        
        // Icono
        const icon = document.createElement('i');
        icon.className = `fas ${category.icon} fa-${Math.min(2, size)}x`;
        circle.appendChild(icon);
        
        // Texto
        const text = document.createElement('div');
        text.className = 'small';
        text.textContent = category.name;
        
        // Count
        const count = document.createElement('div');
        count.className = 'badge bg-secondary';
        count.textContent = relatedGroups.length;
        
        categoryBox.appendChild(circle);
        categoryBox.appendChild(text);
        categoryBox.appendChild(count);
        
        // Añadir evento para mostrar detalles
        categoryBox.style.cursor = 'pointer';
        categoryBox.title = `Ver grupos relacionados con ${category.name}`;
        categoryBox.addEventListener('click', () => {
            showCategoryGroupsModal(category.name, relatedGroups);
        });
        
        chartContainer.appendChild(categoryBox);
    });
    
    summaryContainer.appendChild(chartContainer);
    
    // Añadir botón para ver análisis detallado
    const detailsButton = document.createElement('button');
    detailsButton.className = 'btn btn-sm btn-outline-primary d-block mx-auto mt-2';
    detailsButton.innerHTML = '<i class="fas fa-eye me-1"></i> Ver análisis detallado';
    detailsButton.addEventListener('click', () => {
        showDetailedPermissionAnalysis(userGroups);
    });
    
    summaryContainer.appendChild(detailsButton);
}

/**
 * Muestra un modal con los grupos de una categoría específica
 * @param {string} categoryName - Nombre de la categoría
 * @param {Array} relatedGroups - Grupos relacionados con la categoría
 */
function showCategoryGroupsModal(categoryName, relatedGroups) {
    // Crear modal dinámicamente
    const modalId = 'categoryGroupsModal';
    let modal = document.getElementById(modalId);
    
    if (!modal) {
        modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = modalId;
        modal.tabIndex = '-1';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Grupos de <span id="categoryNameTitle"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <ul id="categoryGroupsList" class="list-group"></ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Actualizar contenido
    document.getElementById('categoryNameTitle').textContent = categoryName;
    
    const groupsList = document.getElementById('categoryGroupsList');
    groupsList.innerHTML = '';
    
    if (relatedGroups.length === 0) {
        groupsList.innerHTML = '<li class="list-group-item text-muted">No hay grupos relacionados con esta categoría</li>';
    } else {
        relatedGroups.forEach(group => {
            const item = document.createElement('li');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = group.full_name || group.name;
            
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary rounded-pill';
            badge.textContent = group.users ? group.users.length : '0';
            badge.title = 'Número de usuarios';
            
            item.appendChild(nameSpan);
            item.appendChild(badge);
            groupsList.appendChild(item);
        });
    }
    
    // Mostrar modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

/**
 * Muestra un análisis detallado de permisos del usuario
 * @param {Array} userGroups - Grupos del usuario
 */
function showDetailedPermissionAnalysis(userGroups) {
    // Implementar en versión futura
    alert('Esta funcionalidad estará disponible en la próxima versión');
}

// Función para mostrar información detallada del usuario
function displayUserDetails(user) {
    // Actualizar el título con el nombre del usuario
    document.getElementById('selectedUserName').textContent = user.name;
    
    // Mostrar información detallada del usuario
    const userInfoContainer = document.getElementById('userInfo');
    if (userInfoContainer) {
        userInfoContainer.innerHTML = `
            <div class="mb-2 text-muted small">
                <strong>Login:</strong> ${user.login}
                ${user.email ? `<br><strong>Email:</strong> ${user.email}` : ''}
                ${user.company_id ? `<br><strong>Empresa:</strong> ${user.company_id[1]}` : ''}
                <br><strong>Grupos:</strong> ${user.groups_id.length}
            </div>
        `;
    }
    
    // Mostrar badges de los grupos asignados
    const userBadgesContainer = document.getElementById('userBadges');
    userBadgesContainer.innerHTML = '';
    
    // Construir un conjunto de todos los grupos, incluyendo heredados
    const directGroupIds = new Set(user.groups_id);
    let allUserGroupIds = new Set(directGroupIds);
    
    // Añadir grupos heredados
    directGroupIds.forEach(groupId => {
        collectInheritedGroups(groupId, allUserGroupIds);
    });
    
    // Convertir a array y ordenar por nombre
    const userGroups = Array.from(allUserGroupIds)
        .map(groupId => allGroups.find(g => g.id === groupId))
        .filter(group => group) // Eliminar nulos
        .sort((a, b) => a.name.localeCompare(b.name));
    
    // Crear badges para cada grupo
    userGroups.forEach(group => {
        const isDirectGroup = directGroupIds.has(group.id);
        const badge = document.createElement('span');
        
        // Estilo diferente para grupos directos vs heredados
        if (isDirectGroup) {
            badge.className = 'badge bg-primary me-1 mb-1';
        } else {
            badge.className = 'badge bg-info me-1 mb-1';
            badge.title = 'Heredado';
        }
        
        // Mostrar el nombre completo en el tooltip si existe
        if (group.full_name) {
            badge.title = group.full_name;
        }
        
        badge.textContent = group.name;
        badge.style.cursor = 'pointer';
        
        // Evento para mostrar detalles del grupo
        badge.addEventListener('click', () => {
            displayGroupDetails(group);
        });
        
        userBadgesContainer.appendChild(badge);
    });
    
    // Generar visualización de permisos
    generatePermissionVisualizations(userGroups);
}
/**
 * Odoo Permissions Manager - Core Functions
 * This file contains the main functionality for the Odoo Permissions Manager application
 * @author: Desarrollado con GitHub Copilot
 * @date: Mayo 2024
 */

// Cache de datos para optimizar rendimiento
const dataCache = {
    users: null,
    groups: null,
    modules: null,
    permissions: {},
    userGroups: {}
};

/**
 * Función para mostrar el indicador de carga
 * @param {string} message - Mensaje a mostrar durante la carga
 */
function showLoading(message = 'Cargando...') {
    const loadingElement = document.getElementById('loadingIndicator');
    
    if (!loadingElement) {
        // Crear el indicador de carga si no existe
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingIndicator';
        loadingDiv.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-25';
        loadingDiv.style.zIndex = '1050';
        
        loadingDiv.innerHTML = `
            <div class="card shadow-sm p-3">
                <div class="d-flex align-items-center">
                    <div class="spinner-border text-primary me-3" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <div id="loadingMessage" class="fw-medium"></div>
                </div>
            </div>
        `;
        
        document.body.appendChild(loadingDiv);
    }
    
    // Actualizar el mensaje
    document.getElementById('loadingMessage').textContent = message;
    document.getElementById('loadingIndicator').style.display = 'flex';
    
    console.log('Cargando: ' + message);
}

/**
 * Función para ocultar el indicador de carga
 */
function hideLoading() {
    const loadingElement = document.getElementById('loadingIndicator');
    if (loadingElement) {
        loadingElement.style.display = 'none';
    }
    
    console.log('Carga completada');
}

/**
 * Función para mostrar mensajes de error
 * @param {string} message - Mensaje de error a mostrar
 */
function showError(message) {
    // Crear un toast para el mensaje de error
    const toastId = 'errorToast' + Date.now();
    
    const toastElement = document.createElement('div');
    toastElement.className = 'toast position-fixed top-0 end-0 m-3';
    toastElement.id = toastId;
    toastElement.setAttribute('role', 'alert');
    toastElement.setAttribute('aria-live', 'assertive');
    toastElement.setAttribute('aria-atomic', 'true');
    toastElement.setAttribute('data-bs-delay', '5000');
    
    toastElement.innerHTML = `
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong class="me-auto">Error</strong>
            <small>Ahora</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;
    
    // Añadir el toast al contenedor
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toastElement);
    
    // Mostrar el toast
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // También registrar en la consola
    console.error(message);
    
    // Anunciar para lectores de pantalla
    const announcement = document.createElement('div');
    announcement.setAttribute('role', 'alert');
    announcement.setAttribute('aria-live', 'assertive');
    announcement.className = 'visually-hidden';
    announcement.textContent = 'Error: ' + message;
    document.body.appendChild(announcement);
    
    // Eliminar después de 5 segundos
    setTimeout(() => {
        if (document.body.contains(announcement)) {
            document.body.removeChild(announcement);
        }
    }, 5000);
}

/**
 * Función para mostrar mensajes informativos
 * @param {string} message - Mensaje informativo a mostrar
 * @param {string} title - Título opcional del mensaje
 */
function showInfo(message, title = 'Información') {
    const toastId = 'infoToast' + Date.now();
    
    const toastElement = document.createElement('div');
    toastElement.className = 'toast position-fixed top-0 end-0 m-3';
    toastElement.id = toastId;
    toastElement.setAttribute('role', 'alert');
    toastElement.setAttribute('aria-live', 'polite');
    toastElement.setAttribute('aria-atomic', 'true');
    toastElement.setAttribute('data-bs-delay', '4000');
    
    toastElement.innerHTML = `
        <div class="toast-header bg-info text-white">
            <i class="fas fa-info-circle me-2"></i>
            <strong class="me-auto">${title}</strong>
            <small>Ahora</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;
    
    // Añadir el toast al contenedor
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toastElement);
    
    // Mostrar el toast
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Registrar en la consola
    console.info(message);
}

/**
 * Función para guardar la selección del usuario en localStorage
 * @param {number} id - ID del usuario o grupo seleccionado
 * @param {boolean} isGroup - Indica si es un grupo
 */
function saveUserSelection(id, isGroup) {
    try {
        localStorage.setItem('lastSelectedId', id);
        localStorage.setItem('lastSelectionIsGroup', isGroup);
        localStorage.setItem('lastSelectionTime', new Date().toISOString());
    } catch (error) {
        console.warn('No se pudo guardar la selección en localStorage:', error);
    }
}

/**
 * Función para restaurar la selección del usuario desde localStorage
 * @returns {Object|null} Datos de la última selección o null si no hay datos guardados
 */
function restoreUserSelection() {
    try {
        const id = localStorage.getItem('lastSelectedId');
        const isGroup = localStorage.getItem('lastSelectionIsGroup') === 'true';
        const time = localStorage.getItem('lastSelectionTime');
        
        if (id && time) {
            // Comprobar si ha pasado mucho tiempo desde la última selección (48 horas)
            const lastTime = new Date(time);
            const now = new Date();
            const diff = now.getTime() - lastTime.getTime();
            const hours = diff / (1000 * 60 * 60);
            
            if (hours < 48) {
                return { id: parseInt(id), isGroup };
            }
        }
    } catch (error) {
        console.warn('No se pudo restaurar la selección desde localStorage:', error);
    }
    
    return null;
}

/**
 * Función para guardar configuración de UI en localStorage
 * @param {Object} settings - Objeto con configuraciones a guardar
 */
function saveUISettings(settings) {
    try {
        const currentSettings = getUISettings();
        const updatedSettings = { ...currentSettings, ...settings };
        localStorage.setItem('uiSettings', JSON.stringify(updatedSettings));
    } catch (error) {
        console.warn('No se pudo guardar la configuración en localStorage:', error);
    }
}

/**
 * Función para obtener configuración de UI desde localStorage
 * @returns {Object} Configuración guardada o valores por defecto
 */
function getUISettings() {
    try {
        const settings = localStorage.getItem('uiSettings');
        return settings ? JSON.parse(settings) : {};
    } catch (error) {
        console.warn('No se pudo obtener la configuración desde localStorage:', error);
        return {};
    }
}

/**
 * Función optimizada para cargar datos iniciales en paralelo
 * @param {string} sessionId - ID de sesión de Odoo
 */
function loadOptimizedData(sessionId) {
    showLoading('Cargando datos...');
    
    // Almacenar el ID de sesión para su uso posterior
    window.odooSessionId = sessionId;
    
    // Definir promesas para las llamadas paralelas
    const promises = [];
    
    // Promesa para cargar usuarios
    const loadUsersPromise = new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    window.allUsers = result.users;
                    resolve(result.users);
                } else {
                    reject(new Error('Error al cargar usuarios: ' + (result.error || 'Error desconocido')));
                }
            })
            .withFailureHandler(error => {
                reject(new Error('Error al cargar usuarios: ' + error));
            })
            .getUsers(sessionId);
    });
    promises.push(loadUsersPromise);
    
    // Promesa para cargar grupos
    const loadGroupsPromise = new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    window.allGroups = result.groups;
                    resolve(result.groups);
                } else {
                    reject(new Error('Error al cargar grupos: ' + (result.error || 'Error desconocido')));
                }
            })
            .withFailureHandler(error => {
                reject(new Error('Error al cargar grupos: ' + error));
            })
            .getGroups(sessionId);
    });
    promises.push(loadGroupsPromise);
    
    // Promesa para cargar módulos
    const loadModulesPromise = new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    window.allModules = result.modules;
                    resolve(result.modules);
                } else {
                    reject(new Error('Error al cargar módulos: ' + (result.error || 'Error desconocido')));
                }
            })
            .withFailureHandler(error => {
                reject(new Error('Error al cargar módulos: ' + error));
            })
            .getModules(sessionId);
    });
    promises.push(loadModulesPromise);
    
    // Resolver todas las promesas
    Promise.all(promises)
        .then(([users, groups, modules]) => {
            // Actualizar cache
            dataCache.users = users;
            dataCache.groups = groups;
            dataCache.modules = modules;
            
            // Poblar listas en la interfaz
            populateUsersList();
            populateModulesList();
            
            // Actualizar estado
            updateFilterInfo();
            
            // Comprobar si hay una selección guardada
            const savedSelection = restoreUserSelection();
            if (savedSelection) {
                // Intentar seleccionar el último usuario/grupo usado
                setTimeout(() => {
                    try {
                        if (savedSelection.isGroup) {
                            // Cambiar a la pestaña de grupos
                            document.getElementById('groups-tab').click();
                            
                            // Buscar y seleccionar el grupo
                            const groupItem = document.querySelector(`#groupsList [data-group-id="${savedSelection.id}"]`);
                            if (groupItem) {
                                groupItem.click();
                            }
                        } else {
                            // Buscar y seleccionar el usuario
                            const userItem = document.querySelector(`#usersList [data-user-id="${savedSelection.id}"]`);
                            if (userItem) {
                                userItem.click();
                            }
                        }
                    } catch (e) {
                        console.warn('No se pudo restaurar la selección anterior:', e);
                    }
                }, 500);
            }
            
            hideLoading();
            showInfo('Datos cargados correctamente', 'Listo');
        })
        .catch(error => {
            hideLoading();
            showError(error.message);
        });
}

/**
 * Función para exportar permisos a CSV
 * @param {number} userId - ID del usuario o grupo
 * @param {boolean} isGroup - Indica si es un grupo o usuario
 */
function exportPermissionsToCSV(userId, isGroup) {
    showLoading('Preparando exportación...');
    
    // Obtener nombre del usuario o grupo
    let entityName = 'exportación';
    if (isGroup) {
        const group = dataCache.groups.find(g => g.id === userId);
        if (group) {
            entityName = group.name.replace(/[^\w\s-]/g, '_');
        }
    } else {
        const user = dataCache.users.find(u => u.id === userId);
        if (user) {
            entityName = user.name.replace(/[^\w\s-]/g, '_');
        }
    }
    
    // Solicitar permisos detallados al servidor
    google.script.run
        .withSuccessHandler(result => {
            if (result.success) {
                // Generar CSV
                let csvContent = "data:text/csv;charset=utf-8,";
                
                // Cabecera
                csvContent += "Módulo,Modelo,Leer,Escribir,Crear,Eliminar,Heredado\n";
                
                // Datos
                const permissions = result.permissions;
                permissions.forEach(perm => {
                    const isInherited = perm.read_inherited || perm.write_inherited || 
                                        perm.create_inherited || perm.unlink_inherited;
                    
                    csvContent += `"${perm.module_name}","${perm.model_name}",` +
                                 `${perm.read},${perm.write},${perm.create},${perm.unlink},` +
                                 `${isInherited}\n`;
                });
                
                // Crear enlace para descargar
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `permisos_${entityName}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                
                // Descargar el archivo
                link.click();
                
                // Limpiar
                document.body.removeChild(link);
                hideLoading();
                showInfo('Exportación completada');
            } else {
                hideLoading();
                showError('Error al exportar permisos: ' + (result.error || 'Error desconocido'));
            }
        })
        .withFailureHandler(error => {
            hideLoading();
            showError('Error al exportar permisos: ' + error);
        })
        .getDetailedPermissions(window.odooSessionId, userId, isGroup);
}

/**
 * Función para mostrar un análisis detallado de permisos
 * @param {Array} userGroups - Grupos del usuario
 */
function showDetailedPermissionAnalysis(userGroups) {
    // Crear modal para el análisis
    const modalId = 'permissionAnalysisModal';
    let modal = document.getElementById(modalId);
    
    if (!modal) {
        modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = modalId;
        modal.tabIndex = '-1';
        modal.setAttribute('aria-labelledby', 'permissionAnalysisModalLabel');
        modal.setAttribute('aria-hidden', 'true');
        
        modal.innerHTML = `
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="permissionAnalysisModalLabel">
                            <i class="fas fa-chart-bar me-2"></i>Análisis Detallado de Permisos
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="analysisSearchInput" class="form-control" placeholder="Buscar en el análisis...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex justify-content-end">
                                    <button id="exportAnalysisBtn" class="btn btn-outline-primary">
                                        <i class="fas fa-file-export me-1"></i> Exportar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <ul class="nav nav-tabs" id="analysisTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" 
                                        data-bs-target="#summary-tab-pane" type="button" role="tab">Resumen</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="module-analysis-tab" data-bs-toggle="tab" 
                                        data-bs-target="#module-analysis-tab-pane" type="button" role="tab">Por Módulo</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="permission-types-tab" data-bs-toggle="tab" 
                                        data-bs-target="#permission-types-tab-pane" type="button" role="tab">Tipos de Permisos</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="inheritance-tab" data-bs-toggle="tab" 
                                        data-bs-target="#inheritance-tab-pane" type="button" role="tab">Herencia</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content mt-3" id="analysisTabContent">
                            <!-- Tab del Resumen -->
                            <div class="tab-pane fade show active" id="summary-tab-pane" role="tabpanel" tabindex="0">
                                <div class="row">
                                    <div class="col-md-6" id="permissionSummaryChart1"></div>
                                    <div class="col-md-6" id="permissionSummaryChart2"></div>
                                </div>
                                <div class="mt-4">
                                    <h6 class="border-bottom pb-2">Estadísticas</h6>
                                    <div id="permissionStats" class="row row-cols-2 row-cols-md-4 g-3 mt-2"></div>
                                </div>
                            </div>
                            
                            <!-- Tab de Análisis por Módulo -->
                            <div class="tab-pane fade" id="module-analysis-tab-pane" role="tabpanel" tabindex="0">
                                <div id="moduleAnalysisContainer" class="table-responsive">
                                    <table class="table table-sm table-striped table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Módulo</th>
                                                <th>Modelos con Acceso</th>
                                                <th>Leer</th>
                                                <th>Escribir</th>
                                                <th>Crear</th>
                                                <th>Eliminar</th>
                                            </tr>
                                        </thead>
                                        <tbody id="moduleAnalysisBody"></tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Tab de Tipos de Permisos -->
                            <div class="tab-pane fade" id="permission-types-tab-pane" role="tabpanel" tabindex="0">
                                <div id="permissionTypesContainer">
                                    <!-- Se llenará dinámicamente -->
                                </div>
                            </div>
                            
                            <!-- Tab de Herencia -->
                            <div class="tab-pane fade" id="inheritance-tab-pane" role="tabpanel" tabindex="0">
                                <div id="inheritanceContainer">
                                    <!-- Se llenará dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Configurar evento para el botón de exportar
        document.getElementById('exportAnalysisBtn').addEventListener('click', function() {
            const selectedUserId = parseInt(document.querySelector('.user-item.active, .group-item.active').getAttribute('data-id'));
            const isGroup = document.querySelector('.group-item.active') !== null;
            exportPermissionsToCSV(selectedUserId, isGroup);
        });
    }
    
    // Mostrar el modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Mostrar indicador de carga dentro del modal
    const modalBody = document.querySelector(`#${modalId} .modal-body`);
    modalBody.innerHTML += `
        <div id="analysisLoading" class="d-flex justify-content-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <span class="ms-3">Generando análisis detallado...</span>
        </div>
    `;
    
    // Obtener el ID del usuario/grupo seleccionado
    const selectedElement = document.querySelector('.user-item.active, .group-item.active');
    if (!selectedElement) {
        document.getElementById('analysisLoading').innerHTML = 'No hay ningún usuario o grupo seleccionado';
        return;
    }
    
    const selectedId = parseInt(selectedElement.getAttribute('data-id'));
    const isGroup = selectedElement.classList.contains('group-item');
    
    // Solicitar permisos detallados al servidor
    google.script.run
        .withSuccessHandler(result => {
            if (result.success) {
                // Ocultar indicador de carga
                document.getElementById('analysisLoading').style.display = 'none';
                
                // Actualizar cada pestaña con los datos recibidos
                updateAnalysisTabs(result.permissions, userGroups);
            } else {
                document.getElementById('analysisLoading').innerHTML = 
                    `<div class="alert alert-danger">Error al obtener permisos: ${result.error || 'Error desconocido'}</div>`;
            }
        })
        .withFailureHandler(error => {
            document.getElementById('analysisLoading').innerHTML = 
                `<div class="alert alert-danger">Error: ${error}</div>`;
        })
        .getDetailedPermissions(window.odooSessionId, selectedId, isGroup);
}

/**
 * Actualiza las pestañas del análisis con los datos recibidos
 * @param {Array} permissions - Lista de permisos
 * @param {Array} userGroups - Grupos del usuario
 */
function updateAnalysisTabs(permissions, userGroups) {
    // Actualizar pestaña de resumen
    updateSummaryTab(permissions);
    
    // Actualizar pestaña de análisis por módulo
    updateModuleAnalysisTab(permissions);
    
    // Actualizar pestaña de tipos de permisos
    updatePermissionTypesTab(permissions);
    
    // Actualizar pestaña de herencia
    updateInheritanceTab(permissions, userGroups);
}

/**
 * Actualiza la pestaña de resumen con gráficos y estadísticas
 * @param {Array} permissions - Lista de permisos
 */
function updateSummaryTab(permissions) {
    // Implementar visualizaciones y estadísticas de resumen
    const statsContainer = document.getElementById('permissionStats');
    
    // Contar totales
    const totalModels = new Set(permissions.map(p => p.model_name)).size;
    const totalModules = new Set(permissions.map(p => p.module_name)).size;
    
    // Contar permisos por tipo
    const readCount = permissions.filter(p => p.read).length;
    const writeCount = permissions.filter(p => p.write).length;
    const createCount = permissions.filter(p => p.create).length;
    const unlinkCount = permissions.filter(p => p.unlink).length;
    
    // Contar permisos heredados vs directos
    const inheritedCount = permissions.filter(p => 
        p.read_inherited || p.write_inherited || p.create_inherited || p.unlink_inherited
    ).length;
    const directCount = totalModels - inheritedCount;
    
    // Actualizar estadísticas
    statsContainer.innerHTML = `
        <div class="col">
            <div class="card h-100 border-primary">
                <div class="card-body text-center">
                    <h6 class="card-title text-primary">Modelos</h6>
                    <p class="card-text display-6">${totalModels}</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card h-100 border-primary">
                <div class="card-body text-center">
                    <h6 class="card-title text-primary">Módulos</h6>
                    <p class="card-text display-6">${totalModules}</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card h-100 border-success">
                <div class="card-body text-center">
                    <h6 class="card-title text-success">Permisos Directos</h6>
                    <p class="card-text display-6">${directCount}</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card h-100 border-info">
                <div class="card-body text-center">
                    <h6 class="card-title text-info">Permisos Heredados</h6>
                    <p class="card-text display-6">${inheritedCount}</p>
                </div>
            </div>
        </div>
    `;
    
    // Crear gráficos (implementación básica para demostración)
    // En una implementación real, usaríamos una biblioteca como Chart.js
    const chart1Container = document.getElementById('permissionSummaryChart1');
    chart1Container.innerHTML = `
        <h6 class="border-bottom pb-2">Distribución de Permisos</h6>
        <div class="d-flex flex-column align-items-center mt-3">
            <div class="progress" style="height: 30px; width: 100%;">
                <div class="progress-bar bg-info" role="progressbar" style="width: ${(readCount/totalModels)*100}%" 
                     aria-valuenow="${readCount}" aria-valuemin="0" aria-valuemax="${totalModels}">
                    Leer (${readCount})
                </div>
            </div>
            <div class="progress mt-2" style="height: 30px; width: 100%;">
                <div class="progress-bar bg-primary" role="progressbar" style="width: ${(writeCount/totalModels)*100}%" 
                     aria-valuenow="${writeCount}" aria-valuemin="0" aria-valuemax="${totalModels}">
                    Escribir (${writeCount})
                </div>
            </div>
            <div class="progress mt-2" style="height: 30px; width: 100%;">
                <div class="progress-bar bg-warning text-dark" role="progressbar" style="width: ${(createCount/totalModels)*100}%" 
                     aria-valuenow="${createCount}" aria-valuemin="0" aria-valuemax="${totalModels}">
                    Crear (${createCount})
                </div>
            </div>
            <div class="progress mt-2" style="height: 30px; width: 100%;">
                <div class="progress-bar bg-danger" role="progressbar" style="width: ${(unlinkCount/totalModels)*100}%" 
                     aria-valuenow="${unlinkCount}" aria-valuemin="0" aria-valuemax="${totalModels}">
                    Eliminar (${unlinkCount})
                </div>
            </div>
        </div>
    `;
    
    const chart2Container = document.getElementById('permissionSummaryChart2');
    chart2Container.innerHTML = `
        <h6 class="border-bottom pb-2">Origen de Permisos</h6>
        <div class="d-flex justify-content-center align-items-center mt-3" style="height: 200px;">
            <div class="position-relative" style="width: 200px; height: 200px;">
                <div class="position-absolute top-0 start-0 end-0 bottom-0 d-flex align-items-center justify-content-center">
                    <div class="rounded-circle bg-success" style="width: ${(directCount/totalModels)*100}%; height: ${(directCount/totalModels)*100}%; min-width: 50px; min-height: 50px; display: flex; align-items: center; justify-content: center;">
                        <span class="text-white fw-bold">${Math.round((directCount/totalModels)*100)}%</span>
                    </div>
                </div>
                <div class="position-absolute bottom-0 end-0 text-center">
                    <span class="badge rounded-pill bg-success">Directos: ${directCount}</span>
                </div>
                <div class="position-absolute top-0 start-0 text-center">
                    <span class="badge rounded-pill bg-info">Heredados: ${inheritedCount}</span>
                </div>
            </div>
        </div>
    `;
}

/**
 * Actualiza la pestaña de análisis por módulo
 * @param {Array} permissions - Lista de permisos
 */
function updateModuleAnalysisTab(permissions) {
    const tableBody = document.getElementById('moduleAnalysisBody');
    tableBody.innerHTML = '';
    
    // Agrupar permisos por módulo
    const modulePermissions = {};
    
    permissions.forEach(perm => {
        if (!modulePermissions[perm.module_name]) {
            modulePermissions[perm.module_name] = {
                models: new Set(),
                read: 0,
                write: 0,
                create: 0,
                unlink: 0
            };
        }
        
        modulePermissions[perm.module_name].models.add(perm.model_name);
        if (perm.read) modulePermissions[perm.module_name].read++;
        if (perm.write) modulePermissions[perm.module_name].write++;
        if (perm.create) modulePermissions[perm.module_name].create++;
        if (perm.unlink) modulePermissions[perm.module_name].unlink++;
    });
    
    // Ordenar módulos por cantidad de modelos (descendente)
    const sortedModules = Object.keys(modulePermissions).sort((a, b) => 
        modulePermissions[b].models.size - modulePermissions[a].models.size
    );
    
    // Crear filas para cada módulo
    sortedModules.forEach(moduleName => {
        const moduleData = modulePermissions[moduleName];
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>${moduleName}</td>
            <td>${moduleData.models.size}</td>
            <td>${moduleData.read} <small class="text-muted">(${Math.round((moduleData.read/moduleData.models.size)*100)}%)</small></td>
            <td>${moduleData.write} <small class="text-muted">(${Math.round((moduleData.write/moduleData.models.size)*100)}%)</small></td>
            <td>${moduleData.create} <small class="text-muted">(${Math.round((moduleData.create/moduleData.models.size)*100)}%)</small></td>
            <td>${moduleData.unlink} <small class="text-muted">(${Math.round((moduleData.unlink/moduleData.models.size)*100)}%)</small></td>
        `;
        
        tableBody.appendChild(row);
    });
}

/**
 * Actualiza la pestaña de tipos de permisos
 * @param {Array} permissions - Lista de permisos
 */
function updatePermissionTypesTab(permissions) {
    const container = document.getElementById('permissionTypesContainer');
    
    // Definir combinaciones de permisos
    const permissionCombinations = [
        { name: 'Solo lectura', filter: p => p.read && !p.write && !p.create && !p.unlink, color: 'info' },
        { name: 'Lectura y escritura', filter: p => p.read && p.write && !p.create && !p.unlink, color: 'primary' },
        { name: 'CRUD completo', filter: p => p.read && p.write && p.create && p.unlink, color: 'success' },
        { name: 'Sin eliminar', filter: p => p.read && p.write && p.create && !p.unlink, color: 'warning' },
        { name: 'Solo escribir', filter: p => !p.read && p.write, color: 'danger' },
        { name: 'Otros patrones', filter: p => true, color: 'secondary' }
    ];
    
    // Asignar modelos a cada combinación (sin duplicados)
    const modelsSeen = new Set();
    const combinationModels = permissionCombinations.map(comb => {
        const models = permissions
            .filter(p => !modelsSeen.has(p.model_name) && comb.filter(p))
            .map(p => {
                modelsSeen.add(p.model_name);
                return p;
            });
        
        return {
            ...comb,
            models
        };
    });
    
    // Construir interfaz
    container.innerHTML = '';
    
    combinationModels.forEach(comb => {
        if (comb.models.length === 0 && comb.name !== 'Otros patrones') return;
        
        const card = document.createElement('div');
        card.className = 'card mb-3';
        
        card.innerHTML = `
            <div class="card-header bg-${comb.color} text-white">
                ${comb.name} (${comb.models.length} modelos)
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Modelo</th>
                                <th>Módulo</th>
                                <th class="text-center">Leer</th>
                                <th class="text-center">Escribir</th>
                                <th class="text-center">Crear</th>
                                <th class="text-center">Eliminar</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${comb.models.map(model => `
                                <tr>
                                    <td>${model.model_name}</td>
                                    <td>${model.module_name}</td>
                                    <td class="text-center">${model.read ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>
                                    <td class="text-center">${model.write ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>
                                    <td class="text-center">${model.create ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>
                                    <td class="text-center">${model.unlink ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
}

/**
 * Actualiza la pestaña de herencia de permisos
 * @param {Array} permissions - Lista de permisos
 * @param {Array} userGroups - Grupos del usuario
 */
function updateInheritanceTab(permissions, userGroups) {
    const container = document.getElementById('inheritanceContainer');
    
    // Separar permisos directos y heredados
    const directPerms = permissions.filter(p => 
        !p.read_inherited && !p.write_inherited && !p.create_inherited && !p.unlink_inherited
    );
    
    const inheritedPerms = permissions.filter(p => 
        p.read_inherited || p.write_inherited || p.create_inherited || p.unlink_inherited
    );
    
    // Construir interfaz
    container.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Los permisos pueden provenir directamente de grupos asignados o ser heredados a través de la jerarquía de grupos.
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-check-circle me-2"></i>Permisos Directos (${directPerms.length})
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            ${directPerms.length > 0 
                                ? directPerms.slice(0, 10).map(p => `
                                    <div class="list-group-item">
                                        <div class="fw-medium">${p.model_name}</div>
                                        <div class="small text-muted">${p.module_name}</div>
                                        <div class="d-flex gap-1 mt-1">
                                            ${p.read ? '<span class="badge bg-info">Leer</span>' : ''}
                                            ${p.write ? '<span class="badge bg-primary">Escribir</span>' : ''}
                                            ${p.create ? '<span class="badge bg-warning text-dark">Crear</span>' : ''}
                                            ${p.unlink ? '<span class="badge bg-danger">Eliminar</span>' : ''}
                                        </div>
                                    </div>
                                `).join('')
                                : '<div class="list-group-item text-muted">No hay permisos directos</div>'
                            }
                            ${directPerms.length > 10 
                                ? `<div class="list-group-item text-center text-muted">
                                     Y ${directPerms.length - 10} más...
                                   </div>` 
                                : ''
                            }
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-share-alt me-2"></i>Permisos Heredados (${inheritedPerms.length})
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            ${inheritedPerms.length > 0 
                                ? inheritedPerms.slice(0, 10).map(p => `
                                    <div class="list-group-item">
                                        <div class="fw-medium">${p.model_name}</div>
                                        <div class="small text-muted">${p.module_name}</div>
                                        <div class="d-flex gap-1 mt-1">
                                            ${p.read_inherited ? '<span class="badge bg-info opacity-75">Leer</span>' : ''}
                                            ${p.write_inherited ? '<span class="badge bg-primary opacity-75">Escribir</span>' : ''}
                                            ${p.create_inherited ? '<span class="badge bg-warning text-dark opacity-75">Crear</span>' : ''}
                                            ${p.unlink_inherited ? '<span class="badge bg-danger opacity-75">Eliminar</span>' : ''}
                                        </div>
                                    </div>
                                `).join('')
                                : '<div class="list-group-item text-muted">No hay permisos heredados</div>'
                            }
                            ${inheritedPerms.length > 10 
                                ? `<div class="list-group-item text-center text-muted">
                                     Y ${inheritedPerms.length - 10} más...
                                   </div>` 
                                : ''
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-sitemap me-2"></i>Cadenas de Herencia
            </div>
            <div class="card-body">
                <p class="card-text">
                    La herencia de permisos fluye a través de los siguientes grupos:
                </p>
                <div id="inheritanceChains" class="d-flex flex-wrap gap-2">
                    ${userGroups.map(group => `
                        <div class="badge bg-light text-dark p-2 d-inline-flex align-items-center">
                            <span>${group.name}</span>
                            ${group.implied_ids && group.implied_ids.length 
                                ? '<i class="fas fa-arrow-right mx-1"></i>' + 
                                  group.implied_ids.map(id => {
                                      const impliedGroup = dataCache.groups.find(g => g.id === id);
                                      return impliedGroup ? impliedGroup.name : `Grupo ${id}`;
                                  }).join(', ')
                                : ''
                            }
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

/**
 * Optimiza la carga de datos para bases de datos muy grandes
 * @param {Array} models - Lista de modelos
 * @param {number} userId - ID del usuario o grupo
 * @param {boolean} isGroup - Indica si es un grupo o usuario
 */
function optimizeForLargeDatabase(models, userId, isGroup) {
    showLoading('Optimizando para base de datos grande...');
    
    // Ordenar modelos por prioridad (basado en uso común)
    const priorityModels = models.filter(model => 
        model.indexOf('res.') === 0 || 
        model.indexOf('ir.') === 0 || 
        model.indexOf('mail.') === 0
    );
    
    const otherModels = models.filter(model => 
        model.indexOf('res.') !== 0 && 
        model.indexOf('ir.') !== 0 && 
        model.indexOf('mail.') !== 0
    );
    
    // Cargar primero los modelos prioritarios
    loadModelsInBatches([...priorityModels, ...otherModels], userId, isGroup, 10);
}

/**
 * Carga modelos en lotes para mejorar rendimiento
 * @param {Array} models - Lista de modelos
 * @param {number} userId - ID del usuario o grupo
 * @param {boolean} isGroup - Indica si es un grupo o usuario
 * @param {number} batchSize - Tamaño del lote
 * @param {number} startIndex - Índice de inicio para la carga en lotes
 */
function loadModelsInBatches(models, userId, isGroup, batchSize = 10, startIndex = 0) {
    if (startIndex >= models.length) {
        hideLoading();
        showInfo('Carga completa', 'Listo');
        return;
    }
    
    // Seleccionar el lote actual
    const currentBatch = models.slice(startIndex, startIndex + batchSize);
    const progress = Math.round((startIndex / models.length) * 100);
    
    showLoading(`Cargando modelos (${progress}%)...`);
    
    // Crear promesas para cada modelo en el lote
    const promises = currentBatch.map(model => 
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        // Guardar en cache
                        dataCache.permissions[model] = result.permissions;
                        resolve(result.permissions);
                    } else {
                        console.warn(`Error al cargar permisos de ${model}: ${result.error}`);
                        resolve(null); // Resolver con null para no romper la carga
                    }
                })
                .withFailureHandler(error => {
                    console.warn(`Error al cargar permisos de ${model}: ${error}`);
                    resolve(null); // Resolver con null para no romper la carga
                })
                .getModelPermissions(window.odooSessionId, model, userId, isGroup);
        })
    );
    
    // Procesar todas las promesas del lote
    Promise.all(promises)
        .then(() => {
            // Cargar siguiente lote
            loadModelsInBatches(models, userId, isGroup, batchSize, startIndex + batchSize);
        })
        .catch(error => {
            console.error('Error al cargar lote de modelos:', error);
            hideLoading();
            showError('Error al cargar permisos: ' + error);
        });
}
    </script>
</body>
</html>
